{% extends "base.html" %}

{% block title %}My Profile - E-Shop{% endblock %}

{% block content %}
<div class="container py-5">
    <h2 class="mb-4 text-center">My Profile</h2>

    {% if user %}
    <div class="row">
        <!-- Profile Picture -->
        <div class="col-lg-3 text-center mb-4">
            <img src="{{ url_for('static', filename='profile_pics/' ~ (user.profile_pic or 'default.png')) }}" alt="Profile Picture" class="img-thumbnail">
            <form method="POST" action="{{ url_for('upload_profile_pic') }}" enctype="multipart/form-data" class="mt-3">
                <input type="file" name="profile_pic" class="form-control mb-2">
                <button class="btn btn-sm btn-primary w-100">Change Picture</button>
            </form>
        </div>

        <!-- Tabs -->
        <div class="col-lg-9">
            <ul class="nav nav-tabs mb-4" id="profileTabs" role="tablist">
                <li class="nav-item">
                    <button class="nav-link active" id="info-tab" data-bs-toggle="tab" data-bs-target="#info">Info</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="orders-tab" data-bs-toggle="tab" data-bs-target="#orders">Orders</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="wishlist-tab" data-bs-toggle="tab" data-bs-target="#wishlist">Wishlist</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="cart-tab" data-bs-toggle="tab" data-bs-target="#cart">Cart</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="addresses-tab" data-bs-toggle="tab" data-bs-target="#addresses">Addresses</button>
                </li>
            </ul>

            <div class="tab-content">
                <!-- Info -->
                <div class="tab-pane fade show active" id="info">
                    <form method="POST" action="{{ url_for('update_profile') }}">
                        <div class="mb-3">
                            <label>Username</label>
                            <input type="text" name="username" class="form-control" value="{{ user.username }}">
                        </div>
                        <div class="mb-3">
                            <label>Email</label>
                            <input type="email" name="email" class="form-control" value="{{ user.email }}">
                        </div>
                        <div class="mb-3">
                            <label>New Password</label>
                            <input type="password" name="password" class="form-control" placeholder="Leave blank to keep current">
                        </div>
                        <div class="mb-3">
                            <label>Account Created</label>
                            <input type="text" class="form-control" value="{{ user.created_at.strftime('%d-%m-%Y') }}" readonly>
                        </div>
                        <button class="btn btn-primary">Update Profile</button>
                    </form>
                </div>

                <!-- Orders -->
                <div class="tab-pane fade" id="orders">
                    {% if user.orders %}
                        <div class="mb-3">
                            <label>Filter Orders:</label>
                            <select id="orderFilter" class="form-select">
                                <option value="All" selected>All</option>
                                <option value="Pending">Pending</option>
                                <option value="Shipped">Shipped</option>
                                <option value="Delivered">Delivered</option>
                            </select>
                        </div>
                        <ul class="list-group" id="orderList">
                            {% for order in user.orders %}
                            <li class="list-group-item order-item" data-status="{{ order.status }}">
                                Order #{{ order.id }} - <span class="badge bg-{{ 'warning' if order.status=='Pending' else ('info' if order.status=='Shipped' else 'success') }}">{{ order.status }}</span>
                            </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p>No orders yet.</p>
                    {% endif %}
                </div>

                <!-- Wishlist -->
                <div class="tab-pane fade" id="wishlist">
                    {% if user.wishlist_items %}
                        <ul class="list-group">
                            {% for item in user.wishlist_items %}
                                <li class="list-group-item">{{ item.product.name }} - ₹{{ item.product.price }}</li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p>No items in wishlist.</p>
                    {% endif %}
                </div>

                <!-- Cart -->
                <div class="tab-pane fade" id="cart">
                    {% if user.cart_items %}
                        <ul class="list-group">
                            {% for item in user.cart_items %}
                                <li class="list-group-item">{{ item.product.name }} x{{ item.quantity }} - ₹{{ item.quantity * item.product.price }}</li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p>Cart is empty.</p>
                    {% endif %}
                </div>

                <!-- Addresses -->
                <div class="tab-pane fade" id="addresses">
                    <form method="POST" action="{{ url_for('add_address') }}">
                        <div class="mb-3">
                            <label>Address Line</label>
                            <input type="text" name="address_line" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label>City</label>
                            <input type="text" name="city" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label>State</label>
                            <input type="text" name="state" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label>Postal Code</label>
                            <input type="text" name="postal_code" class="form-control" required>
                        </div>
                        <button class="btn btn-primary">Add Address</button>
                    </form>

                    {% if user.addresses %}
                        <ul class="list-group mt-3">
                            {% for addr in user.addresses %}
                                <li class="list-group-item">
                                    {{ addr.address_line }}, {{ addr.city }}, {{ addr.state }} - {{ addr.postal_code }}
                                    <a href="{{ url_for('delete_address', address_id=addr.id) }}" class="btn btn-sm btn-danger float-end">Delete</a>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p class="mt-3">No addresses added.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Account Actions -->
    <div class="text-center mt-4">
        <a href="{{ url_for('logout') }}" class="btn btn-danger me-2">Logout</a>
        <a href="{{ url_for('delete_account') }}" class="btn btn-outline-danger">Delete Account</a>
    </div>

    {% else %}
        <p class="text-center text-danger">User not found.</p>
    {% endif %}
</div>

<script>
    // Order filtering
    const filter = document.getElementById('orderFilter');
    const orders = document.querySelectorAll('.order-item');

    filter.addEventListener('change', () => {
        const val = filter.value;
        orders.forEach(o => {
            if(val === 'All' || o.dataset.status === val){
                o.style.display = 'block';
            } else {
                o.style.display = 'none';
            }
        });
    });
</script>
{% endblock %}